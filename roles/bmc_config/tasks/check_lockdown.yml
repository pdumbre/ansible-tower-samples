---
# Check if SystemLockdown is disabled in iDRAC
# Equivalent to: idrac.lockdownCheck()

- name: Check and disable System Lockdown if needed
  block:
    - name: Get System Lockdown Mode status
      uri:
        url: "{{ bmc_base_url }}{{ bmc_urls.attributes }}"
        method: GET
        user: "{{ bmc_user }}"
        password: "{{ bmc_password }}"
        validate_certs: no
        force_basic_auth: yes
        return_content: yes
        status_code: [200]
      register: idrac_attributes
      delegate_to: "{{ bmc_delegate_host }}"

    - name: Check if System Lockdown is disabled
      set_fact:
        lockdown_status: "{{ idrac_attributes.json.Attributes['SystemLockdown.1.SystemLockdownMode'] | default('Disabled') }}"
      when:
        - idrac_attributes is defined
        - idrac_attributes.json is defined

    - name: Display lockdown status
      debug:
        msg: "System Lockdown Mode: {{ lockdown_status }}"
      when:
        - idrac_attributes is defined
        - idrac_attributes.json is defined

    - name: Disable System Lockdown if enabled
      uri:
        url: "{{ bmc_base_url }}{{ bmc_urls.attributes }}"
        method: PATCH
        user: "{{ bmc_user }}"
        password: "{{ bmc_password }}"
        validate_certs: no
        force_basic_auth: yes
        body_format: json
        body:
          Attributes:
            SystemLockdown.1.SystemLockdownMode: "Disabled"
        status_code: [200]
      register: disable_lockdown_result
      delegate_to: "{{ bmc_delegate_host }}"
      when: 
        - idrac_attributes is defined
        - idrac_attributes.json is defined
        - lockdown_status != 'Disabled'

    - name: Wait for iDRAC to apply lockdown changes
      pause:
        seconds: 5
      when: 
        - idrac_attributes is defined
        - lockdown_status != 'Disabled'

    - name: Verify System Lockdown is now disabled
      uri:
        url: "{{ bmc_base_url }}{{ bmc_urls.attributes }}"
        method: GET
        user: "{{ bmc_user }}"
        password: "{{ bmc_password }}"
        validate_certs: no
        force_basic_auth: yes
        return_content: yes
        status_code: [200]
      register: verify_lockdown
      delegate_to: "{{ bmc_delegate_host }}"
      when: 
        - idrac_attributes is defined
        - lockdown_status != 'Disabled'

    - name: Update lockdown status after disable
      set_fact:
        lockdown_status: "{{ verify_lockdown.json.Attributes['SystemLockdown.1.SystemLockdownMode'] | default('Disabled') }}"
      when: lockdown_status != 'Disabled' and verify_lockdown is defined

    - name: Fail if System Lockdown could not be disabled
      fail:
        msg: "Failed to disable System Lockdown. Current status: {{ lockdown_status }}"
      when: lockdown_status != 'Disabled' and verify_lockdown is defined

    - name: Confirm System Lockdown is disabled
      debug:
        msg: "System Lockdown is disabled - proceeding with configuration"
      when: 
        - idrac_attributes is defined
        - idrac_attributes.json is defined

  when:
    - bmc_capabilities.requires_lockdown_check is defined
    - bmc_capabilities.requires_lockdown_check | bool
