# Task: Configure Account Security Settings
# All tasks are conditional on requires_account_security == true

- name: Configure account security settings
  block:
  
    # Retrieves system identifies including mtm, uuild and serial number  
    - name: Extract system identifiers
      set_fact:
        system_sku: "{{ bmc_systems_details.json.SKU }}"
        system_mtm: "{{ bmc_systems_details.json.SKU[0:4] | upper }}"
        system_uuid: "{{ bmc_systems_details.json.UUID }}"
        system_serial: "{{ bmc_systems_details.json.SerialNumber }}"

    - name: Configure selection_properties map for conditional settings
      set_fact:
        selection_properties:
          mtm: "{{ system_mtm }}"
          serial: "{{ system_serial }}"
          uuid: "{{ system_uuid }}"

    - name: Determine server type
      set_fact:
        is_m6_server: "{{ system_mtm is match('^(7X02|7D2X|7D2V|7D76|7D9R|7D73)') }}"
        is_sn550: "{{ system_mtm is match('^7X16') }}"

    - name: Retrieve current account service configuration
      community.general.redfish_info:
        category: Accounts
        command: ListUsers
        baseuri: "{{ bmc_ip }}"
        username: "{{ redfish_user }}"
        password: "{{ redfish_password }}"
        timeout: 30
      register: current_accounts
      delegate_to: "{{ bmc_delegate_host }}"
      ignore_errors: yes

    # M6 Server Configuration (7X02, 7D2X, 7D2V, 7D76, 7D9R, 7D73)
    # accseccfg -am local -lp 0 -pe 0 -pew 0 -pc on -pl 10 -ci 0 -lf 0 -chgnew off -rc 0
    - name: Configure account security of M6 Server
      uri:
        url: "{{ bmc_base_url }}/AccountService"
        method: PATCH
        user: "{{ bmc_user }}"
        password: "{{ bmc_password }}"
        validate_certs: no
        force_basic_auth: yes
        body_format: json
        body:
          MinPasswordLength: 10
          Oem:
            Lenovo:
              PasswordChangeOnFirstAccess: false
              PasswordReuseCount: 0
              PasswordComplexityCheck: true
        status_code: [200, 202, 204]
      register: m6_account_config_api
      delegate_to: "{{ bmc_delegate_host }}"
      when:
        - is_m6_server | bool
      changed_when: m6_account_config_api.status in [200, 202, 204]

    - name: M6 account security configured
      debug:
        msg: "Account security configured for M6 server {{ system_mtm }}"
      when:
        - is_m6_server | bool
        - (m6_account_config_api is changed)

    # SN550 Configuration (7X16)
    # accseccfg -lp 0 -pe 0 -pew 0 -pc off -pl 8 -ci 0 -lf 0 -chgdft off -chgnew off -rc 0
    - name: Configure account security for SN550 server
      community.general.redfish_command:
        category: Accounts
        command: UpdateAccountServiceProperties
        baseuri: "{{ bmc_ip }}"
        username: "{{ redfish_user }}"
        password: "{{ redfish_password }}"
        timeout: 30
        account_properties:
          MinPasswordLength: 8        # -pl 8: password length
      register: sn550_account_config
      delegate_to: "{{ bmc_delegate_host }}"
      when: is_sn550 | bool
      ignore_errors: yes

    - name: Configure SN550 account security
      uri:
        url: "{{ bmc_base_url }}/AccountService"
        method: PATCH
        user: "{{ bmc_user }}"
        password: "{{ bmc_password }}"
        validate_certs: no
        force_basic_auth: yes
        body_format: json
        body:
          MinPasswordLength: 8
          Oem:
            Lenovo:
              PasswordChangeOnFirstAccess: false
              PasswordChangeOnDefault: false
              PasswordReuseCount: 0
              PasswordComplexityCheck: false
        status_code: [200, 202, 204]
      register: sn550_account_config_api
      delegate_to: "{{ bmc_delegate_host }}"
      when:
        - is_sn550 | bool
        - sn550_account_config is failed
      changed_when: sn550_account_config_api.status in [200, 202, 204]

    - name: SN550 account security configured
      debug:
        msg: "Account security configured for SN550 {{ system_mtm }}"
      when:
        - is_sn550 | bool
        - (sn550_account_config is succeeded or sn550_account_config_api is changed)

    - name: Skip configuration for non-M6 systems
      debug:
        msg: "System MTM {{ system_mtm }} is not an M6 server - skipping account security configuration"
      when:
        - not (is_m6_server | bool)
        - not (is_sn550 | bool)
  when: 
    - bmc_capabilities.requires_account_security is defined
    - bmc_capabilities.requires_account_security | bool
   
