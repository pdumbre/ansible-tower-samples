# Enable IPMI over LAN on IMM using Ansible Redfish module

- name: Retrieve network protocol configuration
  community.general.redfish_info:
    category: Manager
    command: GetManagerInventory
    baseuri: "[{{ ipv6_address }}]"
    username: "{{ redfish_user }}"
    password: "{{ new_redfish_password }}"
    timeout: 30
  register: current_protocols
  delegate_to: mgen

- name: Retrieve existing IPMI status
  set_fact:
    current_ipmi_enabled: "{{ current_protocols.redfish_facts.manager.entries[0].NetworkProtocol.IPMI.ProtocolEnabled | default(false) }}"
    current_ipmi_port: "{{ current_protocols.redfish_facts.manager.entries[0].NetworkProtocol.IPMI.Port | default(623) }}"

- name: Check if IPMI needs to be enabled
  set_fact:
    ipmi_needs_update: "{{ not current_ipmi_enabled or current_ipmi_port != 623 }}"

- name: Enable IPMI over LAN
  ansible.builtin.uri:
    url: "https://[{{ ipv6_address }}]/redfish/v1/Managers/1/NetworkProtocol"
    method: PATCH
    user: "{{ redfish_user }}"
    password: "{{ new_redfish_password }}"
    force_basic_auth: yes
    validate_certs: false
    headers:
      Content-Type: application/json
    body_format: json
    body:
      IPMI:
        ProtocolEnabled: true
        Port: 623
    status_code:
      - 200
      - 204
  delegate_to: mgen
  register: ipmi_config
  when: ipmi_needs_update | bool

- name: IPMI already enabled
  debug:
    msg: "IPMI over LAN already enabled on port 623 - no change needed"
  when: not (ipmi_needs_update | bool)
