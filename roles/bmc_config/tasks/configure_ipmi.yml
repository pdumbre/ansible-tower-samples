
# Enable IPMI over LAN on iDRAC using Redfish API
# Equivalent to: idrac.command("racadm set iDRAC.IPMILan.Enable 1")
# IDEMPOTENT: Checks current IPMI state before enabling

- name: Get Manager info
  community.general.redfish_info:
    category: Manager
    baseuri: "{{ bmc_ip }}"
    username: "{{ bmc_user }}"
    password: "{{ bmc_password }}"
  register: manager_info
  delegate_to: "{{ bmc_delegate_host }}"

- debug:
    msg: "{{ manager_info.redfish_facts}}"

- set_stats:
    manager_id: "{{ manager_info.redfish_facts}}"
  

- set_fact:
    manager_id: "{{ manager_info.redfish_facts.manager.entries[0].Id }}"

- name: Get current network protocol configuration
  community.general.redfish_info:
    category: Manager
    resource_id: "{{ manager_id }}"
    subresource: NetworkProtocol
    baseuri: "{{ bmc_ip }}"
    username: "{{ bmc_user }}"
    password: "{{ bmc_password }}"
    timeout: 30
  register: current_protocols
  delegate_to: "{{ bmc_delegate_host }}"

- name: Extract current IPMI status
  set_fact:
    current_ipmi_enabled: "{{ current_protocols.redfish_facts.network_protocols.IPMI.ProtocolEnabled | default(false) }}"
    current_ipmi_port: "{{ current_protocols.redfish_facts.network_protocols.IPMI.Port | default(623) }}"

- name: Check if IPMI needs to be enabled
  set_fact:
    ipmi_needs_update: "{{ not current_ipmi_enabled or current_ipmi_port != 623 }}"

- name: Display current IPMI status
  debug:
    msg: 
      - "IPMI over LAN current status: {{ 'Enabled' if current_ipmi_enabled else 'Disabled' }}"
      - "IPMI Port: {{ current_ipmi_port }}"
      - "Update needed: {{ ipmi_needs_update }}"

- name: Enable IPMI over LAN using Redfish command
  community.general.redfish_command:
    category: Manager
    command: SetManagerAttributes
    baseuri: "{{ bmc_ip }}"
    username: "{{ bmc_user }}"
    password: "{{ bmc_password }}"
    timeout: 30
    manager_attributes:
      NetworkProtocol:
        IPMI:
          ProtocolEnabled: true
          Port: 623
  register: ipmi_config
  delegate_to: "{{ bmc_delegate_host }}"
  when: ipmi_needs_update | bool

- name: IPMI already enabled
  debug:
    msg: "IPMI over LAN already enabled on port 623 - no change needed"
  when: not (ipmi_needs_update | bool)

- name: Display IPMI configuration status
  debug:
    msg: "IPMI over LAN enabled on port 623"
  when: ipmi_config is changed
