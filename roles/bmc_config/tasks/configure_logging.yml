
# Configure iDRAC Logging and supportAssist

- name: Configure iDRAC Logging and SupportAssist EULA
  block:
    - name: Configure iDRAC Logging
      uri:
        url: "{{ bmc_base_url }}{{ bmc_urls.attributes }}"
        method: PATCH
        user: "{{ bmc_user }}"
        password: "{{ bmc_password }}"
        force_basic_auth: yes
        validate_certs: no
        headers:
          Content-Type: application/json
        body_format: json
        body:
          Attributes:
            SysLog.SysLogEnable: "Enabled"
            Logging.1.LCLogAggregation: "Enabled"
        status_code:
          - 200
          - 204
      delegate_to: "{{ bmc_delegate_host }}"

    # Accept EULA License on iDRAC using Redfish API
    # Equivalent to: idrac.command("racadm supportassist accepteula")
    # Note: SupportAssist may not be available on all iDRAC versions

    - name: Check if SupportAssist is available
      uri:
        url: "{{ bmc_base_url }}{{ bmc_urls.dellService }}"
        method: GET
        user: "{{ bmc_user }}"
        password: "{{ bmc_password }}"
        validate_certs: no
        force_basic_auth: yes
        return_content: yes
        status_code: [200, 404]
      register: lc_service_check
      delegate_to: "{{ bmc_delegate_host }}"
      ignore_errors: yes

    - name: Check SupportAssist EULA status
      uri:
        url: "{{ bmc_base_url }}{{ bmc_urls.supportAssistEulaStatus }}"
        method: POST
        user: "{{ bmc_user }}"
        password: "{{ bmc_password }}"
        validate_certs: no
        force_basic_auth: yes
        body_format: json
        body: {}
        status_code: [200, 202, 404]
      register: eula_status
      delegate_to: "{{ bmc_delegate_host }}"
      when: 
        - lc_service_check is defined
        - lc_service_check.status == 200
        
    - name: Check SupportAssist EULA status
      set_stats:
        data:
          eula: "{{ eula_status.json }}"
     
    - name: Accept SupportAssist EULA
      uri:
        url: "{{ bmc_base_url }}{{ bmc_urls.supportAssistAcceptEula }}"
        method: POST
        user: "{{ bmc_user }}"
        password: "{{ bmc_password }}"
        validate_certs: no
        force_basic_auth: yes
        body_format: json
        body: {}
        status_code: [200, 202, 204]
      register: eula_accept
      delegate_to: "{{ bmc_delegate_host }}"
      when: 
        - eula_status is defined
        - eula_status.status is defined
        - eula_status.status in [200, 202]
        - eula_status.json.EULAStatus != "Accepted"

    - name: Display EULA acceptance status
      debug:
        msg: "SupportAssist EULA accepted successfully"
      when: 
        - eula_accept is defined
        - eula_accept is succeeded

    - name: Display SupportAssist not available message
      debug:
        msg: "SupportAssist is not available on this iDRAC version - skipping EULA acceptance"
      when: 
        - lc_service_check is defined
        - lc_service_check.status == 404

  when:
    - bmc_capabilities.requires_logging_and_supportAssist is defined
    - bmc_capabilities.requires_logging_and_supportAssist | bool
