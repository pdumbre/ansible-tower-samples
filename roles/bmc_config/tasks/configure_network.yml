- name: Retrieve details of network configuration
  block:
    - name: Retrieve network configuration using uri module
      uri:
        url: "https://[{{ ipv6LLA }}%{{ bmc_lla_interface | string }}]{{ bmc_urls.ethernet }}"
        method: GET
        user: "{{ bmc_user }}"
        password: "{{ bmc_password }}"
        validate_certs: no
        force_basic_auth: yes
        return_content: yes
        status_code: [200]
      register: current_network
      delegate_to: jump-host

  rescue:
    - name: Fallback - Retrieve network configuration using curl
      shell: |
        curl -k -u "{{ bmc_user }}:{{ bmc_password }}" \
          -X GET \
          -w "\n%{http_code}" \
          "https://[{{ ipv6LLA }}%{{ bmc_lla_interface | string }}]{{ bmc_urls.ethernet }}"
      register: current_network_curl
      delegate_to: jump-host
      changed_when: false
      failed_when: current_network_curl.rc != 0 or (current_network_curl.stdout_lines[-1] | int) not in [200]

    - name: Parse curl response for network configuration
      set_fact:
        current_network:
          json: "{{ current_network_curl.stdout_lines[:-1] | join('\n') | from_json }}"
          status: "{{ current_network_curl.stdout_lines[-1] | int }}"


- name: Retrieve network interface from discovery response
  set_fact:
    network_interface_uri: "{{ current_network.json.Members[0]['@odata.id'] }}"
  when: current_network.json.Members | length > 0
    
- name: Retrieve network interface details
  block:
    - name: Retrieve network interface details using uri module
      uri:
        url: "https://[{{ ipv6LLA }}%{{ bmc_lla_interface }}]{{ network_interface_uri }}"
        method: GET
        user: "{{ bmc_user }}"
        password: "{{ bmc_password }}"
        force_basic_auth: yes
        validate_certs: no
        return_content: yes
      register: network_interface_detail
      delegate_to: jump-host

  rescue:
    - name: Fallback - Retrieve network interface details using curl
      shell: |
        curl -k -u "{{ bmc_user }}:{{ bmc_password }}" \
          -X GET \
          -w "\n%{http_code}" \
          "https://[{{ ipv6LLA }}%{{ bmc_lla_interface }}]{{ network_interface_uri }}"
      register: network_interface_detail_curl
      delegate_to: jump-host
      changed_when: false
      failed_when: network_interface_detail_curl.rc != 0 or (network_interface_detail_curl.stdout_lines[-1] | int) not in [200]

    - name: Parse curl response for network interface details
      set_fact:
        network_interface_detail:
          json: "{{ network_interface_detail_curl.stdout_lines[:-1] | join('\n') | from_json }}"
          status: "{{ network_interface_detail_curl.stdout_lines[-1] | int }}"

  when: network_interface_uri is defined

- name: Retrieve existing network configuration
  set_fact:
    current_mac: "{{ network_interface_detail.json.MACAddress | default('Not available') }}"
    current_ipv6_addresses: "{{ network_interface_detail.json.IPv6Addresses | default([]) }}"
    current_ipv6_addr: "{{ network_interface_detail.json.IPv6Addresses[0].Address | default('') }}"
    current_dhcp: "{{ network_interface_detail.json.DHCPv4.DHCPEnabled | default(false) }}"
    
- name: Check if IPv6 address needs update
  set_fact:
    ipv6_needs_update: "{{ ipv6ULA is defined and current_ipv6_addr != ipv6ULA }}"

- name: Configure network settings
  shell: >
    sshpass -p '{{ hostvars[inventory_hostname].bmc_password }}'
    ssh -6
    {{ bmc_ssh_options | join(' ') }}
    {{ hostvars[inventory_hostname].bmc_user }}@{{ hostvars[inventory_hostname].ipv6LLA }}%{{ hostvars[inventory_hostname].bmc_lla_interface }}
    "ifconfig {{ bmc_network.bmc_network_interface }} -ipv6static enabled -failover shared && usbeth -en enabled"
  register: ssh_result
  failed_when: ssh_result.rc != 0
  when: bmc_capabilities.requires_ssh_for_network is defined
  delegate_to: jump-host

- name: Configure IPv6 and IPv4 Network Settings
  block:
    - name: Configure IPv6 and IPv4 using uri module
      uri:
        url: "https://[{{ ipv6LLA }}%{{ bmc_lla_interface }}]{{ network_interface_uri }}"
        method: PATCH
        user: "{{ bmc_user }}"
        password: "{{ bmc_password }}"
        validate_certs: no
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          DHCPv6:
            OperatingMode: "{{ 'Enabled' if bmc_network.dhcp6_enabled | bool else 'Disabled' }}"
          IPv6StaticAddresses:
            - Address: "{{ ipv6ULA }}"
              SubnetMask: "{{ ipv6_netmask | default('255.255.0.0') }}"
              Gateway: "{{ bmc_network.ipv6_gateway }}"
              AddressOrigin: "Static"
        status_code: [200, 204]
      delegate_to: jump-host
      register: ipv6_config

  rescue:
    - name: Fallback - Configure IPv6 and IPv4 using curl
      shell: |
        curl -k -u "{{ bmc_user }}:{{ bmc_password }}" \
          -X PATCH \
          -H "Content-Type: application/json" \
          -d '{
            "DHCPv6": {
              "OperatingMode": "{{ 'Enabled' if bmc_network.dhcp6_enabled | bool else 'Disabled' }}"
            },
            "IPv6StaticAddresses": [
              {
                "Address": "{{ ipv6ULA }}",
                "SubnetMask": "{{ ipv6_netmask | default('255.255.0.0') }}",
                "Gateway": "{{ bmc_network.ipv6_gateway }}",
                "AddressOrigin": "Static"
              }
            ]
          }' \
          "https://[{{ ipv6LLA }}%{{ bmc_lla_interface }}]{{ network_interface_uri }}" \
          -w "\n%{http_code}"
      register: ipv6_config_curl
      delegate_to: jump-host
      changed_when: ipv6_config_curl.stdout_lines[-1] in ['200', '204']
      failed_when: ipv6_config_curl.rc != 0 or (ipv6_config_curl.stdout_lines[-1] | int) not in [200, 204]

    - name: Set ipv6_config from curl result
      set_fact:
        ipv6_config:
          status: "{{ ipv6_config_curl.stdout_lines[-1] | int }}"
          changed: "{{ ipv6_config_curl.stdout_lines[-1] in ['200', '204'] }}"

  when:
    - ipv6ULA is defined
    - ipv6_needs_update | bool

- name: Wait for network configuration to be effective
  pause:
    seconds: 30
    
- name: Configure Network Settings
  block:
    - name: Configure OEM network settings using uri module
      uri:
        url: "https://[{{ ipv6LLA }}%{{ bmc_lla_interface }}]{{ network_interface_uri }}"
        #url: "{{ bmc_base_url }}{{ network_interface_uri }}"
        method: PATCH
        user: "{{ bmc_user }}"
        password: "{{ bmc_password }}"
        validate_certs: no
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          SLAAC:
                Enabled: "{{ bmc_network.stateless_autoconfig_enabled | bool }}"
          Oem:
            Lenovo:
              NetworkSettingSync: "{{ bmc_network.name_server_sync_enabled | bool }}"
        status_code: [200, 204]
      delegate_to: jump-host
      register: oem_config

  rescue:
    - name: Fallback - Configure OEM network settings using curl
      shell: |
        curl -k -u "{{ bmc_user }}:{{ bmc_password }}" \
          -X PATCH \
          -H "Content-Type: application/json" \
          -d '{
            "SLAAC": {
              "Enabled": {{ bmc_network.stateless_autoconfig_enabled | bool | lower }}
            },
            "Oem": {
              "Lenovo": {
                "NetworkSettingSync": {{ bmc_network.name_server_sync_enabled | bool | lower }}
              }
            }
          }' \
          "https://[{{ ipv6LLA }}%{{ bmc_lla_interface }}]{{ network_interface_uri }}" \
          -w "\n%{http_code}"
      register: oem_config_curl
      delegate_to: jump-host
      changed_when: oem_config_curl.stdout_lines[-1] in ['200', '204']
      failed_when: oem_config_curl.rc != 0 or (oem_config_curl.stdout_lines[-1] | int) not in [200, 204]

    - name: Set oem_config from curl result
      set_fact:
        oem_config:
          status: "{{ oem_config_curl.stdout_lines[-1] | int }}"
          changed: "{{ oem_config_curl.stdout_lines[-1] in ['200', '204'] }}"

  when:
    - bmc_network is defined
    - bmc_network.name_server_sync_enabled is defined
    - bmc_network.stateless_autoconfig_enabled is defined

- name: Wait for network configuration to be effective
  pause:
    seconds: 30
