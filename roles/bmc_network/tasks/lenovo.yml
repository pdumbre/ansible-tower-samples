---
# roles/system_vpd/tasks/main.yml
# Retrieves system mtm 

- name: Get Redfish system info
  community.general.redfish_info:
    category: Systems
    command: GetSystemInventory
    baseuri: "{{ bmc_ip }}"
    username: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    validate_certs: false
  register: rf_info
    
- name: Extract MTM
  set_fact:
    system_mtm: >-
      {{
        (
          rf_info.redfish_facts.system.entries
          | json_query('[].SKU')
          | select('defined')
          | list
          | first
          | default(
              rf_info.redfish_facts.system.entries
              | json_query('[].SubModel')
              | select('defined')
              | list
              | first
            )
        )[0:4] | upper
      }}

- debug:
    msg: "Detected MTM: {{ system_mtm }}"

- name: Display system MTM
  debug:
    msg: "Configuring account security for MTM: {{ system_mtm }}"

- name: Get current network interface configuration using Redfish API
  uri:
    url: "{{ redfish_host }}/redfish/v1/Managers/1/EthernetInterfaces"
    method: GET
    user: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    validate_certs: no
    force_basic_auth: yes
    return_content: yes
    status_code: [200]
  register: current_network
  delegate_to: localhost

- name: Get the first network interface URL
  set_fact:
    network_interface_uri: "{{ current_network.json.Members[0]['@odata.id'] }}"
  when: current_network.json.Members | length > 0

- name: Get first network interface details
  uri:
    url: "{{ redfish_host }}{{ network_interface_uri }}"
    method: GET
    user: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    force_basic_auth: yes
    validate_certs: no
    return_content: yes
  register: network_interface_detail
  delegate_to: localhost
  when: network_interface_uri is defined
  
- name: Extract current network settings from Redfish response
  set_fact:
    current_mac: "{{ network_interface_detail.json.MACAddress | default('Not available') }}"
    current_ipv6_addresses: "{{ network_interface_detail.json.IPv6Addresses | default([]) }}"
    current_ipv6_addr: "{{ network_interface_detail.json.IPv6Addresses[0].Address | default('') }}"
    current_dhcp: "{{ network_interface_detail.json.DHCPv4.DHCPEnabled | default(false) }}"
    
- name: Display current network configuration
  debug:
    msg: 
      - "========================================="
      - "Current Network Configuration"
      - "========================================="
      - "MAC Address: {{ current_mac }}"
      - "IPv6 Address: {{ current_ipv6_addr if current_ipv6_addr else 'Not configured' }}"
      - "DHCP Enabled: {{ current_dhcp }}"
      - "========================================="

- name: Check if IPv6 needs update
  set_fact:
    ipv6_needs_update: "{{ ipv6_address is defined and current_ipv6_addr != ipv6_address }}"

- debug:
    msg:
      - "ipv6_address={{ ipv6_address }}"
      - "type={{ ipv6_address | type_debug }}"

- name: Configure IPv6 on IMM using Redfish API
  uri:
    url: "{{ redfish_host }}{{ network_interface_uri }}"
    method: PATCH
    user: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    validate_certs: no
    force_basic_auth: yes
    body_format: json
    body:
      IPv6StaticAddresses:
        - Address: "{{ ipv6_address }}"
          SubnetMask: "{{ ipv6_netmask | default('255.255.255.0') }}"
          Gateway: "{{ ipv6_gateway | default('') }}"
    status_code: [200, 202, 204]
  register: ipv6_config
  delegate_to: localhost
  when:
    - ipv6_address is defined
    - ipv6_needs_update | bool
  changed_when: ipv6_config.status in [200, 202, 204]

- name: IPv6 already configured
  debug:
    msg: "IPv6 address already set to {{ ipv6_address }} - no change needed"
  when:
    - ipv6_address is defined
    - not (ipv6_needs_update | bool)

- name: Determine if system is M6 compatible
  set_fact:
    is_m6_7x02: "{{ system_mtm.startswith('7X02') }}"
    is_m6_7d2x: "{{ system_mtm.startswith('7D2X') }}"
    is_m6_7d2v: "{{ system_mtm.startswith('7D2V') }}"
    is_m6_7d76: "{{ system_mtm.startswith('7D76') }}"
    is_m6_7d9r: "{{ system_mtm.startswith('7D9R') }}"
    is_m6_7d73: "{{ system_mtm.startswith('7D73') }}"
    is_sn550: "{{ system_mtm.startswith('7X16') }}"

- name: Set M6 configuration flag
  set_fact:
    is_m6_server: "{{ is_m6_7x02 or is_m6_7d2x or is_m6_7d2v or is_m6_7d76 or is_m6_7d9r or is_m6_7d73 }}"

- name: Get current account service configuration using Redfish module
  community.general.redfish_info:
    category: Accounts
    command: ListUsers
    baseuri: "{{ bmc_ip }}"
    username: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    timeout: 30
  register: current_accounts
  delegate_to: localhost
  ignore_errors: yes

- name: Display current account information
  debug:
    msg: "Current account service queried successfully"
  when: current_accounts is succeeded

# M6 Server Configuration (7X02, 7D2X, 7D2V, 7D76, 7D9R, 7D73)
# accseccfg -am local -lp 0 -pe 0 -pew 0 -pc on -pl 10 -ci 0 -lf 0 -chgnew off -rc 0

- name: Configure M6 account security via direct API (fallback)
  uri:
    url: "https://{{ bmc_ip }}/redfish/v1/AccountService"
    method: PATCH
    user: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    validate_certs: no
    force_basic_auth: yes
    body_format: json
    body:
      MinPasswordLength: 10
      Oem:
        Lenovo:
          PasswordChangeOnFirstAccess: false
          PasswordReuseCount: 0
          PasswordComplexityCheck: true
    status_code: [200, 202, 204]
  register: m6_account_config_api
  delegate_to: localhost
  when:
    - is_m6_server | bool
  changed_when: m6_account_config_api.status in [200, 202, 204]

- name: M6 account security configured
  debug:
    msg: "Account security configured for M6 server {{ system_mtm }}"
  when:
    - is_m6_server | bool
    - (m6_account_config_api is changed)

# SN550 Configuration (7X16)
# accseccfg -lp 0 -pe 0 -pew 0 -pc off -pl 8 -ci 0 -lf 0 -chgdft off -chgnew off -rc 0
- name: Configure account security for SN550 using Redfish command
  community.general.redfish_command:
    category: Accounts
    command: UpdateAccountServiceProperties
    baseuri: "{{ bmc_ip }}"
    username: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    timeout: 30
    account_properties:
      MinPasswordLength: 8        # -pl 8: password length
  register: sn550_account_config
  delegate_to: localhost
  when: is_sn550 | bool
  ignore_errors: yes

- name: Configure SN550 account security via direct API (fallback)
  uri:
    url: "https://{{ bmc_ip }}/redfish/v1/AccountService"
    method: PATCH
    user: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    validate_certs: no
    force_basic_auth: yes
    body_format: json
    body:
      MinPasswordLength: 8
      Oem:
        Lenovo:
          PasswordChangeOnFirstAccess: false
          PasswordChangeOnDefault: false
          PasswordReuseCount: 0
          PasswordComplexityCheck: false
    status_code: [200, 202, 204]
  register: sn550_account_config_api
  delegate_to: localhost
  when:
    - is_sn550 | bool
    - sn550_account_config is failed
  changed_when: sn550_account_config_api.status in [200, 202, 204]

- name: SN550 account security configured
  debug:
    msg: "Account security configured for SN550 {{ system_mtm }}"
  when:
    - is_sn550 | bool
    - (sn550_account_config is succeeded or sn550_account_config_api is changed)

- name: Skip configuration for non-M6 systems
  debug:
    msg: "System MTM {{ system_mtm }} is not an M6 server - skipping account security configuration"
  when:
    - not (is_m6_server | bool)
    - not (is_sn550 | bool)

- name: Display account security configuration summary
  debug:
    msg:
      - "========================================="
      - "Account Security Configuration Summary"
      - "========================================="
      - "System MTM: {{ system_mtm }}"
      - "Is M6 Server: {{ is_m6_server }}"
      - "Is SN550: {{ is_sn550 }}"
      - "Module Method: {{ 'Success' if (m6_account_config_api is succeeded or sn550_account_config is succeeded) else 'Used API Fallback' }}"
      - "========================================="

- name: Configure Ports
  uri:
    url: "https://{{ bmc_ip }}/redfish/v1/Managers/1/NetworkProtocol"
    method: PATCH
    user: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    validate_certs: no
    force_basic_auth: yes
    body_format: json
    body:
      SSH:
        ProtocolEnabled: true
        Port: 22
      HTTPS:
        ProtocolEnabled: true
        Port: 443
      HTTP:
        ProtocolEnabled: true
        Port: 80
      SNMP:
        ProtocolEnabled: true
        Port: 161
    status_code: [200, 202, 204]
  register: ports_config
  delegate_to: localhost

- name: Display port configuration status
  debug:
    msg: "Network services configured - SSH: Enabled, HTTPS: Enabled, HTTP: Disabled, SNMP: Enabled"

    
- name: Get Power Restore Policy (Lenovo CLI)
  ansible.builtin.command: cfgimm -am local -g power
  register: power_policy_out
  changed_when: false


- name: Extract PowerRestorePolicy
  set_fact:
    current_power_policy: >-
      {{
        power_policy_out.stdout_lines
        | select('search', 'PowerRestorePolicy')
        | list
        | first
        | regex_replace('.*:\\s*', '')
      }}

  - name: Display current power restore policy
  debug:
    msg:
      - "Current Power Restore Policy: {{ current_power_policy }}"
    
- name: Parse current power restore policy
  set_fact:
    current_policy: "{{ current_power_policy.stdout | regex_search('(alwayson|alwaysoff|restore)', ignorecase=True) | default('unknown') | lower }}"
  when: current_power_policy.rc == 0


- name: Set PowerRestorePolicy via Lenovo CLI
  ansible.builtin.command: >
    cfgimm -am local -rp "{{ power_restore_policy | default('AlwaysOn') }}"
  when: current_system.json.PowerRestorePolicy != power_restore_policy
  register: power_out
  changed_when: "'success' in power_out.stdout"
  failed_when: "'success' not in power_out.stdout"


- name: Power restore policy already configured
  debug:
    msg: "Power restore policy already set to {{ power_restore_policy | default('LastState') }} - no change needed"
  when: not (policy_needs_update | bool)

- name: Display power restore policy configuration result
  debug:
    msg:
      - "========================================="
      - "Power Restore Policy Configuration"
      - "========================================="
      - "Requested Policy: {{ power_restore_policy | default('LastState') }}"
      - "BIOS Method: {{ 'Success' if (power_policy_bios is changed) else 'Failed or Skipped' }}"
      - "Status: {{ 'Configured' if (power_policy_bios is changed) else 'Check manually' }}"
      - "========================================="
  when: policy_needs_update | bool
