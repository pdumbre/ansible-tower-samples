---
# roles/system_vpd/tasks/main.yml
# Retrieves System VPD via Redfish URI

# 1. Discover Systems URI
# Redfish root -> /redfish/v1 -> "Systems": {"@odata.id": "/redfish/v1/Systems"}
- name: Get Redfish Systems Collection
  uri:
    url: "{{ redfish_host }}/redfish/v1/Systems"
    method: GET
    user: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    force_basic_auth: yes
    validate_certs: no
    return_content: yes
  register: systems_collection
  delegate_to: localhost

# 2. Get the first system member URI
- name: Get System URI
  set_fact:
    system_uri: "{{ systems_collection.json.Members[0]['@odata.id'] }}"
  when: systems_collection.json.Members | length > 0


# 3. Retrieve Detail for that System
- name: Get System Detail
  uri:
    url: "{{ redfish_host }}{{ system_uri }}"
    method: GET
    user: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    force_basic_auth: yes
    validate_certs: no
    return_content: yes
  register: system_detail
  delegate_to: localhost
  when: system_uri is defined

# 4. Display Info
- name: Display VPD Information
  debug:
    msg:
      - "Manufacturer: {{ system_detail.json.Manufacturer | default('Unknown') }}"
      - "Model: {{ system_detail.json.Model | default('Unknown') }}"
      - "Serial Number: {{ system_detail.json.SerialNumber | default('Unknown') }}"
      - "UUID: {{ system_detail.json.UUID | default('Unknown') }}"
      - "BIOS Version: {{ system_detail.json.BiosVersion | default('Unknown') }}"
      - "Processor Count: {{ system_detail.json.ProcessorSummary.Count | default('Unknown') }}"
      - "Total Memory: {{ system_detail.json.MemorySummary.TotalSystemMemoryGiB | default('Unknown') }} GiB"

- name: Get current network interface configuration using Redfish API
  uri:
    url: "{{ redfish_host }}/redfish/v1/Managers/1/EthernetInterfaces"
    method: GET
    user: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    validate_certs: no
    force_basic_auth: yes
    return_content: yes
    status_code: [200]
  register: current_network
  delegate_to: localhost

- name: Get the first network interface URL
  set_fact:
    network_interface_uri: "{{ current_network.json.Members[0]['@odata.id'] }}"
  when: current_network.json.Members | length > 0

- name: Get first network interface details
  uri:
    url: "{{ redfish_host }}{{ network_interface_uri }}"
    method: GET
    user: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    force_basic_auth: yes
    validate_certs: no
    return_content: yes
  register: network_interface_detail
  delegate_to: localhost
  when: network_interface_uri is defined
  
- name: Extract current network settings from Redfish response
  set_fact:
    current_mac: "{{ network_interface_detail.json.MACAddress | default('Not available') }}"
    current_ipv6_addresses: "{{ network_interface_detail.json.IPv6Addresses | default([]) }}"
    current_ipv6_addr: "{{ network_interface_detail.json.IPv6Addresses[0].Address | default('') }}"
    current_dhcp: "{{ network_interface_detail.json.DHCPv4.DHCPEnabled | default(false) }}"
    
- name: Display current network configuration
  debug:
    msg: 
      - "========================================="
      - "Current Network Configuration"
      - "========================================="
      - "MAC Address: {{ current_mac }}"
      - "IPv6 Address: {{ current_ipv6_addr if current_ipv6_addr else 'Not configured' }}"
      - "DHCP Enabled: {{ current_dhcp }}"
      - "========================================="

- name: Check if IPv6 needs update
  set_fact:
    ipv6_needs_update: "{{ ipv6_address is defined and current_ipv6_addr != ipv6_address }}"

- debug:
    msg:
      - "ipv6_address={{ ipv6_address }}"
      - "type={{ ipv6_address | type_debug }}"

- name: Configure IPv6 on IMM using Redfish API
  uri:
    url: "{{ redfish_host }}{{ network_interface_uri }}"
    method: PATCH
    user: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    validate_certs: no
    force_basic_auth: yes
    body_format: json
    body:
      IPv6StaticAddresses:
        - Address: "{{ ipv6_address }}"
          SubnetMask: "{{ ipv6_netmask | default('255.255.255.0') }}"
          Gateway: "{{ ipv6_gateway | default('') }}"
    status_code: [200, 202, 204]
  register: ipv6_config
  delegate_to: localhost
  when:
    - ipv6_address is defined
    - ipv6_needs_update | bool
  changed_when: ipv6_config.status in [200, 202, 204]

- name: IPv6 already configured
  debug:
    msg: "IPv6 address already set to {{ ipv6_address }} - no change needed"
  when:
    - ipv6_address is defined
    - not (ipv6_needs_update | bool)

