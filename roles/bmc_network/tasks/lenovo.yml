---
# roles/system_vpd/tasks/main.yml
# Retrieves System VPD via Redfish URI

# 1. Discover Systems URI
# Redfish root -> /redfish/v1 -> "Systems": {"@odata.id": "/redfish/v1/Systems"}
- name: Get Redfish Systems Collection
  uri:
    url: "{{ redfish_host }}/redfish/v1/Systems"
    method: GET
    user: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    force_basic_auth: yes
    validate_certs: no
    return_content: yes
  register: systems_collection
  delegate_to: localhost

# 2. Get the first system member URI
- name: Get System URI
  set_fact:
    system_uri: "{{ systems_collection.json.Members[0]['@odata.id'] }}"
  when: systems_collection.json.Members | length > 0


# 3. Retrieve Detail for that System
- name: Get System Detail
  uri:
    url: "{{ redfish_host }}{{ system_uri }}"
    method: GET
    user: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    force_basic_auth: yes
    validate_certs: no
    return_content: yes
  register: system_detail
  delegate_to: localhost
  when: system_uri is defined

# 4. Display Info
- name: Display VPD Information
  debug:
    msg:
      - "Manufacturer: {{ system_detail.json.Manufacturer | default('Unknown') }}"
      - "Model: {{ system_detail.json.Model | default('Unknown') }}"
      - "Serial Number: {{ system_detail.json.SerialNumber | default('Unknown') }}"
      - "UUID: {{ system_detail.json.UUID | default('Unknown') }}"
      - "BIOS Version: {{ system_detail.json.BiosVersion | default('Unknown') }}"
      - "Processor Count: {{ system_detail.json.ProcessorSummary.Count | default('Unknown') }}"
      - "Total Memory: {{ system_detail.json.MemorySummary.TotalSystemMemoryGiB | default('Unknown') }} GiB"

# 5. Network Config (Standard)
- name: Configure IMM Hostname
  lenovo.thinksystem.onecli_config:
    command: set
    option: IMM.HostName
    value: "{{ imm_hostname }}"
    transport: "{{ transport | default('https') }}"
    ip: "{{ redfish_host }}"
    username: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
  delegate_to: localhost

# 6. Network Config (Refactored to use onecli_config for Idempotency)
- name: Configure DHCP (IPv4)
  lenovo.thinksystem.onecli_config:
    command: set
    option: IMM.DHCP1
    value: "{{ 'Enable' if imm_dhcp_enabled | default(imm_use_dhcp) | default(false) else 'Disable' }}"
    transport: "{{ transport | default('https') }}"
    ip: "{{ redfish_host  }}"
    username: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
  delegate_to: localhost

- name: Configure IPv6 Settings
  when: imm_ipv6_address is defined
  block:
    - name: Enable IPv6
      lenovo.thinksystem.onecli_config:
        command: set
        option: IMM.IPv6_Enable
        value: "Enable"
        transport: "{{ transport | default('https') }}"
        ip: "{{ redfish_host }}"
        username: "{{ redfish_user }}"
        password: "{{ redfish_password }}"
      delegate_to: localhost

    - name: Set IPv6 Address
      lenovo.thinksystem.onecli_config:
        command: set
        option: IMM.IPv6Address1
        value: "{{ imm_ipv6_address }}"
        transport: "{{ transport | default('https') }}"
        ip: "{{ redfish_host }}"
        username: "{{ redfish_user }}"
        password: "{{ redfish_password }}"
      delegate_to: localhost

    - name: Set IPv6 Prefix
      lenovo.thinksystem.onecli_config:
        command: set
        option: IMM.IPv6Prefix1
        value: "{{ imm_ipv6_prefix | default(64) }}"
        transport: "{{ transport | default('https') }}"
        ip: "{{ redfish_host }}"
        username: "{{ redfish_user }}"
        password: "{{ redfish_password }}"
      delegate_to: localhost

