
- name: Retrieve System details
  community.general.redfish_info:
    category: Systems
    command: GetSystemInventory
    baseuri: "[{{ ipv6_address }}]"
    username: "{{ redfish_user }}"
    password: "{{ new_redfish_password }}"
    validate_certs: false
    delegate_to: mgen
  register: rf_info
    
- name: Retrieve system identifiers
  ansible.builtin.set_fact:
    system_mtm: >-
      {{
        (
          rf_info.redfish_facts.system.entries
          | json_query('[].SKU')
          | select('defined')
          | list
          | first
          | default(
              rf_info.redfish_facts.system.entries
              | json_query('[].SubModel')
              | select('defined')
              | list
              | first
            )
        )[0:4] | upper
      }}
      
- name: Configure system details
  ansible.builtin.set_fact:
    systems: >-
      {{
        rf_info.redfish_facts.system.entries
        | default([])
        | map('last')
        | list
      }}
  when:
    - rf_info is defined
    - rf_info.redfish_facts is defined
    - rf_info.redfish_facts.system is defined

- name: Retrieve SerialNumber
  ansible.builtin.set_fact:
    system_serial: "{{ systems | map(attribute='SerialNumber') | first | default('UNKNOWN') }}"
    
- name: Determine if system is M6 compatible
  set_fact:
    is_m6_7x02: "{{ system_mtm.startswith('7X02') }}"
    is_m6_7d2x: "{{ system_mtm.startswith('7D2X') }}"
    is_m6_7d2v: "{{ system_mtm.startswith('7D2V') }}"
    is_m6_7d76: "{{ system_mtm.startswith('7D76') }}"
    is_m6_7d9r: "{{ system_mtm.startswith('7D9R') }}"
    is_m6_7d73: "{{ system_mtm.startswith('7D73') }}"
    is_sn550: "{{ system_mtm.startswith('7X16') }}"

- name: Set M6 configuration details
  set_fact:
    is_m6_server: "{{ is_m6_7x02 or is_m6_7d2x or is_m6_7d2v or is_m6_7d76 or is_m6_7d9r or is_m6_7d73 }}"

- name: Retrieve existing account service configuration 
  community.general.redfish_info:
    category: Accounts
    command: ListUsers
    baseuri: "[{{ ipv6_address }}]"
    username: "{{ redfish_user }}"
    password: "{{ new_redfish_password }}"
    timeout: 30
    delegate_to: mgen
  register: current_accounts


# M6 Server Configuration (7X02, 7D2X, 7D2V, 7D76, 7D9R, 7D73)
# accseccfg -am local -lp 0 -pe 0 -pew 0 -pc on -pl 10 -ci 0 -lf 0 -chgnew off -rc 0

- name: Configure M6 account security
  uri:
    url: "https://[{{ ipv6_address }}]/redfish/v1/AccountService"
    method: PATCH
    user: "{{ redfish_user }}"
    password: "{{ new_redfish_password }}"
    validate_certs: no
    force_basic_auth: yes
    body_format: json
    body:
      MinPasswordLength: 10
      Oem:
        Lenovo:
          PasswordChangeOnFirstAccess: false
          PasswordReuseCount: 0
          PasswordComplexityCheck: true
    status_code: [200, 202, 204]
  register: m6_account_config_api
  delegate_to: mgen
  when:
    - is_m6_server | bool
  changed_when: m6_account_config_api.status in [200, 202, 204]

- name: M6 account security configured
  debug:
    msg: "Account security configured for M6 server {{ system_mtm }}"
  when:
    - is_m6_server | bool
    - (m6_account_config_api is changed)

# SN550 Configuration (7X16)
# accseccfg -lp 0 -pe 0 -pew 0 -pc off -pl 8 -ci 0 -lf 0 -chgdft off -chgnew off -rc 0
- name: Configure account security for SN550 configuration
  community.general.redfish_command:
    category: Accounts
    command: UpdateAccountServiceProperties
    baseuri: "[{{ ipv6_address }}]"
    username: "{{ redfish_user }}"
    password: "{{ new_redfish_password }}"
    timeout: 30
    account_properties:
      MinPasswordLength: 8        # -pl 8: password length
  register: sn550_account_config
  delegate_to: mgen
  when: is_sn550 | bool
  ignore_errors: yes

- name: Configure SN550 account security
  uri:
    url: "https://[{{ ipv6_address }}]/redfish/v1/AccountService"
    method: PATCH
    user: "{{ redfish_user }}"
    password: "{{ new_redfish_password }}"
    validate_certs: no
    force_basic_auth: yes
    body_format: json
    body:
      MinPasswordLength: 8
      Oem:
        Lenovo:
          PasswordChangeOnFirstAccess: false
          PasswordChangeOnDefault: false
          PasswordReuseCount: 0
          PasswordComplexityCheck: false
    status_code: [200, 202, 204]
  register: sn550_account_config_api
  delegate_to: mgen
  when:
    - is_sn550 | bool
    - sn550_account_config is failed
  changed_when: sn550_account_config_api.status in [200, 202, 204]

- name: SN550 account security configured
  debug:
    msg: "Account security configured for SN550 {{ system_mtm }}"
  when:
    - is_sn550 | bool
    - (sn550_account_config is succeeded or sn550_account_config_api is changed)

- name: Skip configuration for non-M6 systems
  debug:
    msg: "System MTM {{ system_mtm }} is not an M6 server - skipping account security configuration"
  when:
    - not (is_m6_server | bool)
    - not (is_sn550 | bool)

- name: Configure Ports
  uri:
    url: "https://[{{ ipv6_address }}]/redfish/v1/Managers/1/NetworkProtocol"
    method: PATCH
    user: "{{ redfish_user }}"
    password: "{{ new_redfish_password }}"
    validate_certs: no
    force_basic_auth: yes
    body_format: json
    body:
      SSH:
        ProtocolEnabled: true
        Port: 22
      HTTPS:
        ProtocolEnabled: true
        Port: 443
      HTTP:
        ProtocolEnabled: true
        Port: 80
      SNMP:
        ProtocolEnabled: true
        Port: 161
    status_code: [200, 202, 204]
  register: ports_config
  delegate_to: mgen


# Enable IPMI over LAN on IMM using Ansible Redfish module

- name: Retrieve network protocol configuration
  community.general.redfish_info:
    category: Manager
    command: GetManagerInventory
    baseuri: "[{{ ipv6_address }}]"
    username: "{{ redfish_user }}"
    password: "{{ new_redfish_password }}"
    timeout: 30
  register: current_protocols
  delegate_to: mgen

- name: Retrieve existing IPMI status
  set_fact:
    current_ipmi_enabled: "{{ current_protocols.redfish_facts.manager.entries[0].NetworkProtocol.IPMI.ProtocolEnabled | default(false) }}"
    current_ipmi_port: "{{ current_protocols.redfish_facts.manager.entries[0].NetworkProtocol.IPMI.Port | default(623) }}"

- name: Check if IPMI needs to be enabled
  set_fact:
    ipmi_needs_update: "{{ not current_ipmi_enabled or current_ipmi_port != 623 }}"

- name: Enable IPMI over LAN
  ansible.builtin.uri:
    url: "https://[{{ ipv6_address }}]/redfish/v1/Managers/1/NetworkProtocol"
    method: PATCH
    user: "{{ redfish_user }}"
    password: "{{ new_redfish_password }}"
    force_basic_auth: yes
    validate_certs: false
    headers:
      Content-Type: application/json
    body_format: json
    body:
      IPMI:
        ProtocolEnabled: true
        Port: 623
    status_code:
      - 200
      - 204
  delegate_to: mgen
  register: ipmi_config
  when: ipmi_needs_update | bool

- name: IPMI already enabled
  debug:
    msg: "IPMI over LAN already enabled on port 623 - no change needed"
  when: not (ipmi_needs_update | bool)

- name: Retrieve existing BIOS settings
  uri:
    url: "https://[{{ ipv6_address }}]/redfish/v1/Systems/1/Bios"
    method: GET
    user: "{{ redfish_user }}"
    password: "{{ new_redfish_password }}"
    validate_certs: no
    force_basic_auth: yes
    return_content: yes
    status_code: [200]
  register: current_bios
  delegate_to: mgen


# Configure Operating mode to Maximum Performance on BMC using SSH CLI

- name: Retrieve existing operating mode
  set_fact:
    operating_mode: "{{ bmc_operating_mode | default('Maximum Performance') }}"

- name: Configure operating mode
  delegate_to: mgen
  shell: >
    sshpass -p '{{ hostvars[inventory_hostname].new_redfish_password }}'
    ssh -o StrictHostKeyChecking=no
    {{ hostvars[inventory_hostname].redfish_user }}@{{ hostvars[inventory_hostname].bmc_lla_ip }}%{{ hostvars[inventory_hostname].bmc_lla_interface }}
    "asu set OperatingModes.ChooseOperatingMode "{{ operating_mode }}"
  register: operating_mode_result
  failed_when: operating_mode_result.rc != 0

- name: Load performance settings configuration
  ansible.builtin.set_fact:
    perf_config: "{{ performance_asu_settings | default({}) }}"

- name: Filter applicable performance settings based on conditions
  ansible.builtin.set_fact:
    applicable_settings: "{{ perf_config | select_applicable_settings(selection_properties) }}"

- name: Check if performance settings need to be applied
  ansible.builtin.set_fact:
    has_performance_settings: "{{ applicable_settings | length > 0 }}"

# Apply BIOS settings via Redfish PATCH to pending configuration
- name: Apply performance BIOS settings
  ansible.builtin.uri:
    url: "https://[{{ ipv6_address }}]/redfish/v1/Systems/1/Bios/Settings"
    method: PATCH
    user: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    body_format: json
    body:
      Attributes: "{{ settings_to_apply | default(applicable_settings) }}"
    validate_certs: false
    force_basic_auth: true
    status_code: [200, 204]
  register: bios_patch_result
  when:
    - has_performance_settings | bool
    - (settings_to_apply | default(applicable_settings) | length > 0)
  failed_when: false

- name: Log performance settings applied
  ansible.builtin.debug:
    msg: "Applied BIOS settings via Redfish: {{ settings_to_apply | default(applicable_settings) | list }}"
  when:
    - has_performance_settings | bool
    - (bios_patch_result is succeeded or bios_patch_fallback_result is succeeded)

- name: Check if system reboot is required
  ansible.builtin.debug:
    msg: "BIOS settings have been updated. System reboot may be required for changes to take effect."
  when:
    - has_performance_settings | bool
    - (bios_patch_result is succeeded or bios_patch_fallback_result is succeeded)

# Configure Mellanox 100G adapter to Ethernet mode
# Equivalent to: imm.setMellanox100Gadapter("Slot3", "Ethernet")
# Only applies to specific models: 7D2X, 7D2V, 7D73

- name: Check if Mellanox adapter configuration is needed
  set_fact:
    configure_mellanox: "{{ vpd_mtm is defined and (vpd_mtm.startswith('7D2X') or vpd_mtm.startswith('7D2V') or vpd_mtm.startswith('7D73')) }}"

- name: Retrieve adapter list from system
  uri:
    url: "https://[{{ ipv6_address }}]/redfish/v1/Systems/1/NetworkInterfaces"
    method: GET
    user: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    validate_certs: no
    force_basic_auth: yes
    return_content: yes
    status_code: [200]
  register: network_interfaces
  delegate_to: mgen
  when: configure_mellanox | default(false)

- name: Check for Mellanox ConnectX-6 adapter in Slot 3
  set_fact:
    mellanox_adapter_found: true
    mellanox_ethernet_only: "{{ item.Name is search('Ethernet Adapter') }}"
  loop: "{{ network_interfaces.json.Members | default([]) }}"
  when:
    - configure_mellanox | default(false)
    - network_interfaces.json is defined
    - item.Name is defined
    - "'Mellanox ConnectX-6' in item.Name"
    - "'Slot 3' in item.Name or 'slot-3' in item.Name"

- name: Configure Mellanox adapter
  uri:
    url: "https://[{{ ipv6_address }}]/redfish/v1/Systems/1/NetworkInterfaces/Slot3"
    method: PATCH
    user: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    validate_certs: no
    force_basic_auth: yes
    body_format: json
    body:
      Oem:
        Lenovo:
          PortMode: "Ethernet"
    status_code: [200, 202, 204]
  register: mellanox_config
  delegate_to: mgen
  when:
    - configure_mellanox | default(false)
    - mellanox_adapter_found | default(false)
    - not (mellanox_ethernet_only | default(false))

- name: Check ethernet mode of Mellanox adapter
  debug:
    msg: "Mellanox adapter already supports Ethernet mode only"
  when:
    - configure_mellanox | default(false)
    - mellanox_adapter_found | default(false)
    - mellanox_ethernet_only | default(false)

- name: Check the availability of Mellanox adapter
  fail:
    msg: "Mellanox ConnectX-6 100GbE adapter not found in Slot 3"
  when:
    - configure_mellanox | default(false)
    - not (mellanox_adapter_found | default(false))
    - fail_on_missing_mellanox | default(false)

- name: Skip Mellanox configuration
  debug:
    msg: "Mellanox adapter configuration not required for this system model"


