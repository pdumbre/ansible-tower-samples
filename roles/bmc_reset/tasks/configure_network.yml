
- name: Configure BMC power policies and network parameters
  delegate_to: mgen
  command: >
    sshpass -p '{{ hostvars[inventory_hostname].new_redfish_password }}'
    ssh -o StrictHostKeyChecking=no
    {{ hostvars[inventory_hostname].ru7_user }}@{{ hostvars[inventory_hostname].bmc_lla_ipv6 }}%{{ hostvars[inventory_hostname].bmc_lla_interface }}
    "ifconfig {{ bmc_network.bmc_network_interface }} -ipv6static enabled -failover shared; usbeth -en enabled; power -rp {{ powerrp }}"

- name: Configure BMC Network Settings
  shell: >
    curl -k -u {{ ru7_user }}:{{ new_redfish_password }}
    -H "Content-Type: application/json"
    -X PATCH
    "https://[{{ bmc_lla_ip }}%25{{ bmc_lla_interface }}]/{{ nic_url }}"
    --data-raw '{
      "DHCPv6": {
        "OperatingMode": "{{ "Enabled" if bmc_network.dhcp6_enabled else "Disabled" }}"
      },
      "IPv6StaticAddresses": [
        {
          "Address": "{{ ipv6_address }}",
          "PrefixLength": {{ bmc_network.ipv6_prefix | int }}
        }
      ],
      "StatelessAddressAutoConfig": {
        "IPv6AutoConfigEnabled": {{ bmc_network.stateless_autoconfig_enabled | lower }}
      }
    }'
  delegate_to: mgen
  register: curl_nic_patch_result
  changed_when: false

- name: Wait for network configuration to apply
  pause:
    seconds: 10

- name: Configure BMC Failover and DNS Sync properties
  uri:
    url: "https://[{{ ipv6_address }}]{{ nic_url }}"
    method: PATCH
    user: "{{ redfish_user }}"
    password: "{{ new_redfish_password }}"
    validate_certs: no
    force_basic_auth: yes
    headers:
      Content-Type: "application/json"
    body_format: json
    body:
      DHCPv4:
        Enabled: "{{ bmc_network.dhcp6_enabled | bool }}"
      IPv6StaticAddresses:
        - Address: "{{ ipv6_address }}"
          SubnetMask: "{{ ipv6_netmask | default('255.255.0.0') }}"
          Gateway: "{{ bmc_network.ipv6_gateway }}"
      IPv4StaticAddresses:
        - Address: "{{ ru7_address }}"
          SubnetMask: "{{ ipv4_netmask | default('255.255.0.0') }}"
      Oem:
        Lenovo:
          "NetworkSettingSync": "{{ bmc_network.name_server_sync_enabled }}"
    status_code: [200, 204]
  delegate_to: mgen  
  register: ipv6_oem_config
  when:
    - bmc_network.name_server_sync_enabled is defined
