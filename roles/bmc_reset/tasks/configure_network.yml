
- name: Discover interface for BMC link local address
  ansible.builtin.raw: ip -6 neigh show | grep -i {{ bmc_lla_ip }} | awk '{print $3}' | head -n1
  delegate_to: mgen
  register: bmc_lla_interface_result

- name: Configure link-local address interface
  set_fact:
    bmc_lla_interface: "{{ bmc_lla_interface_result.stdout | trim }}"
    bmc_lla_ipv6: "{{ bmc_lla_ip }}"

- name: Get current BMC information before reset
  uri:
    url: "https://[{{ ru7_ipv6_address }}]/redfish/v1/Managers/1"
    method: GET
    user: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    validate_certs: no
    force_basic_auth: yes
    return_content: yes
    status_code: [200]
  register: pre_reset_bmc_info
  delegate_to: mgen
  ignore_errors: yes

- name: Display current BMC information
  debug:
    msg:
      - "Current BMC Firmware: {{ pre_reset_bmc_info.json.FirmwareVersion | default('Unknown') }}"
      - "Current BMC Model: {{ pre_reset_bmc_info.json.Model | default('Unknown') }}"
      - "Current BMC Status: {{ pre_reset_bmc_info.json.Status.State | default('Unknown') }}"
  when: pre_reset_bmc_info is succeeded

- name: Perform factory reset using Redfish ResetToDefaults action
  uri:
    url: "https://[{{ ru7_ipv6_address }}]/redfish/v1/Managers/1/Actions/Manager.ResetToDefaults"
    method: POST
    user: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    validate_certs: no
    force_basic_auth: yes
    body_format: json
    body:
      ResetType: "{{ imm_reset_type | default('ResetAll') }}"
    status_code: [200, 202, 204]
    timeout: 60
  register: factory_reset_result
  delegate_to: mgen
  when: not ansible_check_mode
  ignore_errors: yes

- name: Check if reset was accepted
  debug:
    msg:
      - "Factory reset initiated successfully"
      - "Status Code: {{ factory_reset_result.status }}"
      - "BMC will reboot and reset to defaults"
  when:
    - not ansible_check_mode
    - factory_reset_result is succeeded

- name: Handle reset failure
  debug:
    msg:
      - "Factory reset failed or not supported"
      - "Error: {{ factory_reset_result.msg | default('Unknown error') }}"
      - "Attempting alternative reset method..."
  when:
    - not ansible_check_mode
    - factory_reset_result is failed
    
- name: Wait for BMC to begin reboot
  pause:
    seconds: 30
  when:
    - not ansible_check_mode
    - factory_reset_result is succeeded or alternative_reset_result is succeeded

- name: Wait for BMC to become unreachable (rebooting)
  uri:
    url: "https://[{{ ru7_ipv6_address }}]/redfish/v1/Managers/1"
    method: GET
    user: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    validate_certs: no
    force_basic_auth: yes
    status_code: [200]
    timeout: 10
  register: bmc_reachable
  delegate_to: localhost
  until: bmc_reachable is failed
  retries: 12
  delay: 10
  ignore_errors: yes
  when:
    - not ansible_check_mode
    - factory_reset_result is succeeded

- name: Display reboot status
  debug:
    msg: "BMC is rebooting... This may take 5-10 minutes"
  when:
    - not ansible_check_mode
    - bmc_reachable is failed

- name: Wait for BMC to complete reboot and become available
  uri:
    url: "https://[{{ bmc_lla_ip }}%{{ bmc_lla_interface }}]/redfish/v1/Managers/1"
    method: GET
    user: "USERID"  # Default username after factory reset
    password: "PASSW0RD"  # Default password after factory reset
    validate_certs: no
    force_basic_auth: yes
    return_content: yes
    status_code: [200]
    timeout: 30
  register: bmc_available
  delegate_to: localhost
  until: bmc_available is succeeded
  retries: 60
  delay: 10
  when:
    - not ansible_check_mode
    - factory_reset_result is succeeded

- name: Verify BMC is accessible with default credentials
  debug:
    msg:
      - "========================================="
      - "Factory Reset Complete"
      - "========================================="
      - "BMC is now accessible with default credentials:"
      - "  Username: USERID"
      - "  Password: PASSW0RD"
      - "BMC Firmware: {{ bmc_available.json.FirmwareVersion | default('Unknown') }}"
      - "BMC Status: {{ bmc_available.json.Status.State | default('Unknown') }}"
      - "========================================="
      - "IMPORTANT: Reconfigure the BMC before use"
      - "========================================="
  when:
    - not ansible_check_mode
    - bmc_available is succeeded

- name: Display next steps
  debug:
    msg:
      - "========================================="
      - "Next Steps After Factory Reset"
      - "========================================="
      - "1. Update inventory with default credentials:"
      - "   ansible_user: USERID"
      - "   ansible_password: PASSW0RD"
      - ""
      - "2. Run BMC configuration playbook:"
      - "   ansible-playbook configure_bmc.yml --limit {{ inventory_hostname }}"
      - ""
      - "3. Configure network settings"
      - "4. Create/update user accounts"
      - "5. Apply BIOS and performance settings"
      - "6. Configure power policies"
      - "========================================="
  when:
    - not ansible_check_mode
    - bmc_available is succeeded

- name: Wait for BMC to respond via LLA
  ansible.builtin.wait_for:
    host: "[{{ bmc_lla_ip }}%{{ bmc_lla_interface }}]"  # e.g., fe80::xxxx%eth0
    port: 443
    delay: 5
    timeout: 300
    state: started

- name: Retrieve existing network configuration of BMC
  command: >
    curl -k -u {{ ru7_user }}:{{ new_redfish_password }} --fail
    https://[{{ bmc_lla_ip }}%{{ bmc_lla_interface }}]/{{nic_url}}
  delegate_to: mgen
  register: curl_nic_result
  changed_when: false

- name: Enable ipv6 static mode and power policy after successful BMC reset
  delegate_to: mgen
  command: >
    sshpass -p '{{ hostvars[inventory_hostname].new_redfish_password }}'
    ssh -o StrictHostKeyChecking=no
    {{ hostvars[inventory_hostname].ru7_user }}@{{ hostvars[inventory_hostname].bmc_lla_ipv6 }}%{{ hostvars[inventory_hostname].bmc_lla_interface }}
    "ifconfig {{ bmc_network.bmc_network_interface }} -ipv6static enabled -failover shared; usbeth -en enabled; power -rp {{ powerrp }}"

- name: Configure ipv6 address and StatelessAddressAutoConfig setting
  shell: >
    curl -k -u {{ ru7_user }}:{{ new_redfish_password }}
    -H "Content-Type: application/json"
    -X PATCH
    "https://[{{ bmc_lla_ip }}%25{{ bmc_lla_interface }}]/{{ nic_url }}"
    --data-raw '{
      "DHCPv6": {
        "OperatingMode": "{{ "Enabled" if bmc_network.dhcp6_enabled else "Disabled" }}"
      },
      "IPv6StaticAddresses": [
        {
          "Address": "{{ ru7_ipv6_address }}",
          "PrefixLength": {{ bmc_network.ipv6_prefix | int }}
        }
      ],
      "StatelessAddressAutoConfig": {
        "IPv6AutoConfigEnabled": {{ bmc_network.stateless_autoconfig_enabled | lower }}
      }
    }'
  delegate_to: mgen
  register: curl_nic_patch_result
  changed_when: false

- name: Wait for configuration to apply
  pause:
    seconds: 10

- name: Configure Lenovo Failover and DNS Sync
  uri:
    url: "{{ ru7_host }}{{ nic_url }}"
    method: PATCH
    user: "{{ redfish_user }}"
    password: "{{ redfish_password }}"
    validate_certs: no
    force_basic_auth: yes
    headers:
      Content-Type: "application/json"
    body_format: json
    body:
      DHCPv4:
        Enabled: "{{ bmc_network.dhcp6_enabled | bool }}"
      IPv6StaticAddresses:
        - Address: "{{ ru7_ipv6_address }}"
          SubnetMask: "{{ ipv6_netmask | default('255.255.0.0') }}"
          Gateway: "{{ bmc_network.ipv6_gateway }}"
      IPv4StaticAddresses:
        - Address: "{{ ru7_address }}"
          SubnetMask: "{{ ipv4_netmask | default('255.255.0.0') }}"
      Oem:
        Lenovo:
          "NetworkSettingSync": "{{ bmc_network.name_server_sync_enabled }}"
    status_code: [200, 204]
  delegate_to: mgen  
  register: ipv6_oem_config
  when:
    - bmc_network.name_server_sync_enabled is defined
