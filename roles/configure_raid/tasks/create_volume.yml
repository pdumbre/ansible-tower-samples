# Create RAID volume

- name: Extract drive URLs (alternative method)
  set_fact:
    drive_urls: "{{ m2_storage.json.Drives | json_query('[*].\"@odata.id\"') }}"
  when: m2_storage.json.Drives is defined

- name: Convert drive URLs to Redfish object array
  set_fact:
    drives: "{{ drive_urls | map('community.general.dict_kv', '@odata.id') | list }}"

- debug:
    msg: "{{ drives }}"

- debug:
    var: drives | type_debug

- name: Create RAID volume
  uri:
    url: "{{ bmc_storage_url}}/{{ controller_name }}/Volumes"
    method: POST
    user: "{{ bmc_user }}"
    password: "{{ bmc_password }}"
    validate_certs: no
    force_basic_auth: yes
    body_format: json
    body:
      RAIDType: "{{ raid_config.raid_level | upper }}"
      Drives: "{{ drives }}"
    status_code: [200, 201, 202, 204]
  register: volume_create
  delegate_to: "{{ bmc_delegate_host }}"
  #retries: "{{ max_retries }}"
  #delay: "{{ retry_delay }}"
  #until: volume_create.status in [200, 201, 202, 204]
  failed_when: false

- debug:
    msg: "{{ volume_create }}"

- name: Check if RAID creation failed with UEFI POST message
  set_fact:
    need_uefi_boot: true
  when: >
    (volume_create.status not in [200, 201, 202]) and
    (volume_create.json.error is defined)
    
- name: Handle volume creation requiring system reboot
  block: 
    - name: Set next boot to UEFI Setup (one-time)
      uri:
        url: "{{ bmc_systems_url }}"
        method: PATCH
        user: "{{ bmc_user }}"
        password: "{{ bmc_password }}"
        validate_certs: no
        force_basic_auth: yes
        body_format: json
        body:
          Boot:
            BootSourceOverrideTarget: BiosSetup
            BootSourceOverrideEnabled: Once
        status_code: [200, 204]
      register: ufi_result
      delegate_to: "{{ bmc_delegate_host }}"  

    - name: Restart Server
      uri:
        url: "{{ bmc_systems_url }}/Actions/ComputerSystem.Reset"
        method: POST
        user: "{{ bmc_user }}"
        password: "{{ bmc_password }}"
        validate_certs: no
        force_basic_auth: yes
        body_format: json
        body:
          ResetType: "ForceRestart"
        status_code: [200, 204]
      delegate_to: "{{ bmc_delegate_host }}"

    - name: Wait for system to reach setup state
      uri:
        url: "{{ bmc_systems_url }}"
        method: GET
        user: "{{ bmc_user }}"
        password: "{{ bmc_password }}"
        validate_certs: no
        force_basic_auth: yes
        return_content: yes
        status_code: [200]
      register: power_state_check
      delegate_to: "{{ bmc_delegate_host }}"
      retries: "{{ max_retries }}"
      delay: "{{ delay_power_on }}"
      until: >
        power_state_check.json.PowerState is defined and
        power_state_check.json.PowerState == "On"
      failed_when: false

    - name: Wait for storage controller discovery
      uri:
        url: "{{ bmc_storage_url }}"
        method: GET
        user: "{{ bmc_user }}"
        password: "{{ bmc_password }}"
        validate_certs: no
      register: storage_list
      retries: "{{ max_retries }}"
      delay: "{{ delay_power_on }}"
      until:
        - storage_list.status == 200
        - storage_list.json.Members | length > 0
      delegate_to: "{{ bmc_delegate_host }}"

    - name: Wait before retrying volume creation
      pause:
        seconds: "{{ power_on_wait_time }}"
        
    - name: Retry volume creation after power cycle
      uri:
        url: "{{ bmc_storage_url }}/{{ storage_config.storage_controller_id }}/Volumes"
        method: POST
        user: "{{ bmc_user }}"
        password: "{{ bmc_password }}"
        validate_certs: no
        force_basic_auth: yes
        body_format: json
        body:
          RAIDType: "{{ raid_config.raid_level | upper }}"
          Drives: "{{ drives }}"
        status_code: [200, 201, 202, 204]
      register: volume_create
      delegate_to: "{{ bmc_delegate_host }}"
      retries: "{{ max_retries }}"
      delay: "{{ delay_power_on }}"
      until: volume_create.status in [200, 201, 202, 204]
      failed_when: false

  when: 
    - need_uefi_boot | default(false)

- name: Verify volume creation
  fail:
    msg: "Creating volume failed. Status: {{ volume_create.status | default('Unknown') }}"
  when: >
    volume_create.status is not defined or
    volume_create.status not in [200, 201, 202, 204]

- name: Wait after volume creation
  pause:
    seconds: "{{ volume_create_wait_time }}"

- name: Verify volume was created successfully
  uri:
    url: "{{ bmc_storage_url}}/{{ storage_config.storage_controller_id }}/Volumes"
    method: GET
    user: "{{ bmc_user }}"
    password: "{{ bmc_password }}"
    validate_certs: no
    force_basic_auth: yes
    return_content: yes
    status_code: [200]
  register: volumes_verify
  delegate_to: "{{ bmc_delegate_host }}"

- name: Display created volumes
  debug:
    msg: "Volumes created: {{ volumes_verify.json.Members | length }}"

- name: Wait for RAID configuration to stabilize
  pause:
    seconds: "{{ raid_config_wait_time }}"

- name: Volume creation completed
  debug:
    msg: "RAID volume created successfully"
