- name: Build volume list
  set_fact:
    volume_list: "{{ volumes.json | default({}) | json_query('Members[].\"@odata.id\"') | default([]) }}"

- debug:
    msg: "{{ volume_list }}"

- name: Configure BMC endpoint
  set_fact:
    bmc_ip: "{{ bmc_ip | regex_replace('/$', '') }}"

- name: Filter volumes safe for deletion
  set_fact:
    volume_list: >-
      {{
        volumes.json.Members
        | rejectattr(
            'Oem.Dell.PendingOperations',
            'contains',
            'Delete'
          )
        | list
      }}
  when: bmc_config.support_deletion_job is defined

- debug:
    msg: "{{ volume_list }}"

- name: Delete existing RAID volumes
  uri:
    url: "https://{{ bmc_ip }}{{ item }}"
    method: DELETE
    user: "{{ bmc_user }}"
    password: "{{ bmc_password }}"
    validate_certs: no
    status_code: [200, 202, 204, 400]
  loop: "{{ volume_list }}"
  register: delete_results
  delegate_to: "{{ bmc_delegate_host }}"
  when: volume_list | length > 0
  failed_when: false

- name: Restart Server
  uri:
    url: "{{ bmc_systems_url }}/Actions/ComputerSystem.Reset"
    method: POST
    user: "{{ bmc_user }}"
    password: "{{ bmc_password }}"
    validate_certs: no
    force_basic_auth: yes
    body_format: json
    body:
      ResetType: "ForceRestart"
    status_code: [200, 204]
  delegate_to: "{{ bmc_delegate_host }}"

- name: Wait for system to reach setup state
  uri:
    url: "{{ bmc_systems_url }}"
    method: GET
    user: "{{ bmc_user }}"
    password: "{{ bmc_password }}"
    validate_certs: no
    force_basic_auth: yes
    return_content: yes
    status_code: [200]
  register: power_state_check
  delegate_to: "{{ bmc_delegate_host }}"
  retries: "{{ max_retries }}"
  delay: "{{ delay_power_on }}"
  until: >
    power_state_check.json.PowerState is defined and
    power_state_check.json.PowerState == "On"
  failed_when: false

- name: Wait for storage controller discovery
  uri:
    url: "{{ bmc_storage_url }}"
    method: GET
    user: "{{ bmc_user }}"
    password: "{{ bmc_password }}"
    validate_certs: no
  register: storage_list
  retries: "{{ max_retries }}"
  delay: "{{ delay_power_on }}"
  until:
    - storage_list.status == 200
    - storage_list.json.Members | length > 0
  delegate_to: "{{ bmc_delegate_host }}"

- name: Wait for Dell Lifecycle jobs to complete
  block:
    - name: Check job queue status
      uri:
        url: "{{ bmc_manager_url }}/Jobs"
        method: GET
        user: "{{ bmc_user }}"
        password: "{{ bmc_password }}"
        validate_certs: no
        force_basic_auth: yes
        return_content: yes
        status_code: [200]
      register: job_queue_status
      delegate_to: "{{ bmc_delegate_host }}"

    - debug:
        msg: "{{ job_queue_status.json.Members }}"

    - name: Fetch full details for each job
      uri:
        url: "{{ bmc_base_url }}{{ item['@odata.id'] }}"
        method: GET
        user: "{{ bmc_user }}"
        password: "{{ bmc_password }}"
        validate_certs: no
        force_basic_auth: yes
        return_content: yes
        status_code: [200]
      register: job_details_results
      loop: "{{ job_queue_status.json.Members | default([]) }}"
      loop_control:
        label: "{{ item['@odata.id'] }}"
      delegate_to: "{{ bmc_delegate_host }}"

    - name: Check for pending or running jobs
      set_fact:
        has_pending_jobs: "{{ job_details_results.results | default([]) | map(attribute='json') | selectattr('JobState', 'defined') | selectattr('JobState', 'in', ['Pending', 'Running', 'New', 'Scheduled']) | list | length > 0 }}"

    - name: Clean up pending jobs if detected
      debug:
        msg: "Existing job detected. Attempting cleanup before creating a new job..."
      when: has_pending_jobs | bool

    - name: Wait for pending jobs to complete
      block:
        - name: Re-fetch job details to check completion
          uri:
            url: "{{ bmc_base_url }}{{ item['@odata.id'] }}"
            method: GET
            user: "{{ bmc_user }}"
            password: "{{ bmc_password }}"
            validate_certs: no
            force_basic_auth: yes
            return_content: yes
            status_code: [200]
          register: job_wait_details
          loop: "{{ job_queue_status.json.Members | default([]) }}"
          loop_control:
            label: "{{ item['@odata.id'] }}"
          delegate_to: "{{ bmc_delegate_host }}"

        - name: Assert no pending or running jobs remain
          assert:
            that:
              - job_wait_details.results | default([]) | map(attribute='json') | selectattr('JobState', 'defined') | selectattr('JobState', 'in', ['Pending', 'Running', 'New', 'Scheduled']) | list | length == 0
            fail_msg: "Jobs still pending or running"
          retries: 20
          delay: 30
      when: has_pending_jobs | bool
  when:
    - bmc_config.requires_job_cleanup | default(false) | bool
  delegate_to: "{{ bmc_delegate_host }}"

- name: Verify all RAID volumes are deleted
  uri:
    url: "{{ bmc_storage_url}}/{{ controller_name }}/Volumes"
    method: GET
    user: "{{ bmc_user }}"
    password: "{{ bmc_password }}"
    force_basic_auth: yes
    validate_certs: no
  register: volumes_check
  #retries: 20
  #delay: 15
  #until: volumes_check.json.Members | length == 0
  delegate_to: "{{ bmc_delegate_host }}"

- debug:
    msg: "{{ volumes_check }}"

- name: Confirm deletion success
  debug:
    msg: "Volumes successfully deleted."

# Made with Bob
